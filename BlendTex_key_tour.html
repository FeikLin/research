<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>

<style>
#instructions{
	position: relative;
	top:20%;
	margin: 0 auto;
	border: 2px solid gray;
	width: 800px;
	text-align: center;
	font-size: 18px;
}

.Button{
	width: 120px;
	text-align: center;
	border: 2px solid blue;
	background: rgb(234, 227, 255);
	margin: 0 auto;
}

.testDiv{
	position: relative;
	top:5%;
	width: 1000px;
	margin: auto;
	text-align: center;
}

#tour_div{
	display: none;
}

#transition{
	display:none;
	font-size: 20px;
}

.trialDiv{
	position: relative;
	top:5%;
	width: 1000px;
	margin: auto;
	text-align: center;
}

#video_div{
	display: none;
}

#fix_div{
	display: none;
	padding-top: 60px;
	padding-left:10px;
}

#probe_div{
	display: none;
}

.response_type{
	display: none;
	padding-top: 120px;
	font-size: 25px;
}

#thanks{
	top:40px;
	width: 200px;
	margin:0 auto;
	font-size: 35px;
	color: green;
	display: none;
}
</style>


<div id="instructions">
Welcome to the blending textures study.
<p>In this study, you will first be given a video tour for the whole environment, along with a small window of topdown view. Next the real task will start. In each trial, you will see a 2s <b>video</b> on moving through a room. After the video, you will see a <b>noise image</b>. Next, another <b>image</b> will pop up and disappear quickly, followed by <b>a question asking whether this image matches with the first or last scene you see in the video</b>. You can choose either <b>Yes</b> by clicking <b>Arrow Left</b> or <b>No</b> by clicking <b>Arrow Right</b>. After answering the question, next trial will automatically start.</p>
<p>This task is completely anonymously. Your participation is voluntary and you can stop at any time. If you are ready, click the button below and the task will start very shortly. The total task is about <b>10 min</b>.</p>
<div class="Button">
<a href="#" id="TourButton">Take a tour!!</a>
</div></div>

<div class= "testDiv">
<div id="tour_div">
<p><video width="960px" height="540px" autoplay muted id="front">
   <source src="" type="video/mp4"></video></p>
<p>&nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp
	&nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp
	&nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp
	<video width="240px" height="135px" autoplay muted id="topdown">
	<source src="" type="video/mp4"></video></p>
</div>
<div id="transition">
<p>The tour ends. Please continue by click 
<div class="Button"><a href="#" id="StartButton">Start the experiment!!</a></div></p>
</div>
</div>

<div class = "trialDiv">
<div id="video_div">
<p><video width="960px"	height="540px" autoplay muted id="video">
	<source src="" type="video/mp4">
</video></p></div>
<div id="fix_div">
<p><img src="white noise.jpg" width="320" height="320" id="noise"></p></div>
<div id="probe_div">
<p><img src="" id="image" width="640"></p></div>
<div id="response_div1" class="response_type">
<p>Does this image looks like <b>last</b> texture you saw in the video?</p>
<p> <b>Yes &#8592;</b> &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp <b>No &#8594;</b> </p></div>
<div id="response_div2" class="response_type">
<p>Does this image looks like <b>first</b> texture you saw in the video?</p>
<p> <b>Yes &#8592;</b> &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp <b>No &#8594;</b> </p></div>
</div>

<div id="thanks"> The task is end. Thank you for you participation!<p> 
If you have any feedback on the experiment, please share it below and submit.<p>
<input type="text" id="feedback" name="feedback" placeholder="Feedback (may leave blank)"></div> 

<div>
<input type="hidden" id="RepeatNO" name="RepeatNO">
<input type="hidden" id="BType" name="BType">
<input type="hidden" id="Boundary" name="Boundary">
<input type="hidden" id="ProbeLevel" name="ProbeLevel">
<input type="hidden" id="Response" name="Response">
<input type="hidden" id="RT" name="RT">
<input type="hidden" id="ProbeName" name="ProbeName">
<input type="hidden" id="VidName" name="VidName">
<input type="hidden" id="env" name="env">
<input type="hidden" id= "rolln" name="rolln">
<input type="hidden" id="qn" name="qn">
</div>


<script>
//roll it 6 times for 6 subjects(hits) to make sure every event has every order.//
var probe_order = [[0, 1, 2], [2, 0, 1], [1, 2, 0], [0, 2, 1], [2, 1, 0], [1, 0, 2]]; 
var rolln = Math.floor(Math.random()*6); // generate between [0,5]
//var env = 'env_' + Math.floor((Math.random()*4)+1); // generate between [1,4]
var env = 'env_1'
var qn = Math.floor(Math.random()*2+1);

var RepeatNO = ''; 
var BType = ''; 
var Boundary = '';
var ProbeLevel = '';
var Response = ''; 
var RT = '';  
var ProbeName = '';
var VidName = '';

var top_path = 'https://feikailin.s3.amazonaws.com/blendingtex/';
var nBlock = 3; 
var nProbe = 18;
var startTime;
var curTrial = 0;
var curRepeat = 0;
var totalRepeat = 2;
var images_pool = {'open_dw_nb':['open_dw_25_T1', 'open_dw_50_T1', 'open_dw_75_T1'],
                   'open_dw_b':['open_dw_25_T2', 'open_dw_50_T2', 'open_dw_75_T2'],
                   'glass_dw_nb':['glass_dw_25_T1', 'glass_dw_50_T1', 'glass_dw_75_T1'],
                   'glass_dw_b':['glass_dw_25_T2', 'glass_dw_50_T2', 'glass_dw_75_T2'],
                   'door_dw_nb':['door_dw_25_T1', 'door_dw_50_T1', 'door_dw_75_T1'],
                   'door_dw_b':['door_dw_25_T2', 'door_dw_50_T2', 'door_dw_75_T2']};
var videos_pool = {'open_dw_nb':'open_dw_0-48',
                   'open_dw_b':'open_dw_48-96',
                   'glass_dw_nb':'glass_dw_300-348',
                   'glass_dw_b':'glass_dw_348-396',
                   'door_dw_nb':'door_dw_400-448',
                   'door_dw_b':'door_dw_448-496'};
var events = ['open_dw_nb', 'open_dw_b', 'glass_dw_nb', 'glass_dw_b', 'door_dw_nb', 'door_dw_b']; //6//
var TrialimgPool = [[],[],[]];
var TrialvidPool = [[],[],[]];
var withinblock = [0,1,2,3,4,5];

/*Set the list of probe-images display orders. Done before the real experiment starts*/ 
function roll(rolln){
	for (i=0;i<rolln;i++){
		var firstelment = probe_order.shift();
		probe_order.push(firstelment);
	};
};

/*prepare img and video pools for each subject. Done before the real experiment starts*/
function buildpool(){
	roll(rolln);  
	/*reconstruct the images_pool by changing the displaying order of probe-images for each event, based on the controlled probe_order*/
	for (var j=0;j<events.length;j++){
		var index = probe_order[j];   
		images_pool[events[j]] = index.map(i => images_pool[events[j]][i]);
	};
	/*construct the trial pools for this subject. loop thru the first probe_image of all events first to build a block and then move to the next one. In total there will be three blocks, each containing one probe_image for six events. The video is mapped with probe_image*/
	for (var k=0;k<nBlock;k++){
		for (var q=0;q<events.length;q++){
			TrialimgPool[k].push(images_pool[events[q]][k]);
			TrialvidPool[k].push(videos_pool[events[q]]);
		};
	};
};

/* Fisher-Yates shuffle */
function shuffle(o){
    for(var j, x, i = o.length; i; j = Math.floor(Math.random() * i), x = o[--i], o[i] = o[j], o[j] = x);
    return o;
}

/*shuffle the event within block, preserving the displaying order of blocks. To prepare repeat for the event*/ 
function preprepeat(){
	for (var j=0;j<nBlock;j++){
		withinblock = shuffle(withinblock);
		TrialimgPool[j] = withinblock.map(i => TrialimgPool[j][i]);
		TrialvidPool[j] = withinblock.map(i => TrialvidPool[j][i]);
	}; 
};

function loadurl(){
	var block = Math.floor((curTrial%nProbe)/events.length);
	var img = TrialimgPool[block][(curTrial%nProbe)%events.length];
	var vid = TrialvidPool[block][(curTrial%nProbe)%events.length];
	document.getElementById('image').src = top_path + env +'/'+ img + '.JPEG';
	document.getElementById('video').src = top_path + env +'/'+ vid + '.mp4';
	ProbeName = ProbeName + ' ' + img; 
	VidName = VidName + ' ' + vid;
	BType = BType + ' ' + img.substring(0,5);
	(vid.includes('96')) ? Boundary = Boundary + ' ' + 'True' : Boundary = Boundary + ' ' + 'False';
	if (img.includes('50')) {
		ProbeLevel = ProbeLevel + ' ' + '50';
	} else if (img.includes('25')) {
		ProbeLevel = ProbeLevel + ' ' + '25';
	} else {
		ProbeLevel = ProbeLevel + ' ' + '75';
	};	
};

function presskey(){
	$(document).bind('keydown', function(event){
		if (event.which == 37){
			savedata('True');
			$(document).unbind('keydown');
		} else if (event.which == 39){
			savedata('False');
			$(document).unbind('keydown');
		} else {
			alert('Please press Left arrow for Yes or Right arrow for No');
			pressKey();
		};
	});
};

function savedata(ans){
	var rt = new Date() - startTime;

	RepeatNO = RepeatNO + ' ' + curRepeat;
	Response = Response + ' ' + ans;
	RT = RT + ' ' + rt;
	showtrial();
};

function exportdata(){
	$('#RepeatNO').val(RepeatNO);
	$('#BType').val(BType);
	$('#Boundary').val(Boundary);
	$('#ProbeLevel').val(ProbeLevel); 
	$('#Response').val(Response);
	$('#RT').val(RT);
	$('#ProbeName').val(ProbeName);
	$('#VidName').val(VidName);
	$('#env').val(env);
	$('#rolln').val(rolln);
	$('#qn').val(qn);
};

function testmode(){
	document.getElementById('front').src = top_path + 'tour/' + 'front' + '.mp4';
	document.getElementById('topdown').src = top_path + 'tour/' + 'topdown' + '.mp4';
	$('#tour_div').show();
	console.log('in testmode now');
	document.getElementById('front').play();
	document.getElementById('topdown').play();
	setTimeout(function(){
		$('#tour_div').hide();
		$('#transition').show();
		$('#StartButton').click(function(){
			$('#transition').hide();
			showtrial();
		});
	}, 26500);
};

function showtrial(){
	$('#response_div'+qn).hide();
	if (curTrial%nProbe == 0){
		preprepeat();
		curRepeat ++;
	};

	if (curRepeat <= totalRepeat){
		loadurl();
		curTrial ++;
		setTimeout(function(){
			$('#video_div').show();
			document.getElementById('video').play();
			setTimeout(function(){
				$('#video_div').hide();
				$('#fix_div').show();
				setTimeout(function(){
					$('#fix_div').hide();
					$('#probe_div').show();
					setTimeout(function(){
						$('#probe_div').hide();
						$('#response_div'+qn).show();
						startTime = new Date();
						presskey();
					},500);
				}, 500);
			}, 2250);//2250
		}, 250);
	} else {
		exportdata();
		$('#submitButton').show();
		$('.trialDiv').hide();
		$('#thanks').show();
	};
};

$(document).ready(function() {
	buildpool();
	$('#submitButton').hide();
	$('#TourButton').click(function(){
		$('#TourButton').hide();
		$('#instructions').hide();
		testmode();
	});
});

</script>